В контексте фракционных NFT и реализации механизма permit (EIP-2612), безопасность подписей играет критическую роль. Ниже рассмотрены основные аспекты безопасности и лучшие практики.

## 1. Основные принципы безопасности

- **Уникальность подписей**
  - Каждая подпись должна быть уникальной для конкретной NFT
  - Использование `tokenId` в доменном разделителе
  - Предотвращение повторного использования подписей между разными NFT

- **Управление nonce**
  - Отслеживание уникального nonce для каждого адреса в контексте каждой NFT
  - Инкрементация nonce после каждого использования подписи
  - Предотвращение атак повторного воспроизведения (replay attacks)

## 2. Доменный разделитель (Domain Separator)

```solidity
bytes32 public DOMAIN_SEPARATOR = keccak256(
    abi.encode(
        keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract,uint256 tokenId)"),
        keccak256(bytes(name)),
        keccak256(bytes(version)),
        chainId,
        address(this),
        tokenId
    )
);
```

## 3. Структура подписи

- **Типизированные данные (EIP-712)**
  - Использование структурированных данных для подписи
  - Человекочитаемый формат для пользователей
  - Защита от фишинговых атак

## 4. Основные уязвимости

1. **Replay-атаки**
   - Повторное использование подписи
   - Защита: правильное управление nonce

2. **Cross-chain уязвимости**
   - Использование подписи на другой сети
   - Защита: включение chainId в доменный разделитель

3. **Front-running**
   - Перехват и опережение транзакций
   - Защита: временные ограничения для подписей

## 5. Лучшие практики

1. **Валидация входных данных**
   ```solidity
   require(deadline >= block.timestamp, "Signature expired");
   require(signer != address(0), "Invalid signer");
   require(nonces[signer] == nonce, "Invalid nonce");
   ```

2. **Проверка восстановленного адреса**
   ```solidity
   address recovered = ecrecover(
       keccak256(abi.encodePacked("\x19\x01", DOMAIN_SEPARATOR, hash)),
       v, r, s
   );
   require(recovered == signer, "Invalid signature");
   ```

3. **Безопасное обновление nonce**
   ```solidity
   nonces[signer] = nonce + 1;
   ```

## 6. Рекомендации по имплементации

1. **Тестирование**
   - Написание тестов для всех сценариев подписи
   - Проверка граничных случаев
   - Симуляция атак

2. **Мониторинг**
   - Отслеживание необычных паттернов использования подписей
   - Логирование важных событий
   - Система оповещения о подозрительной активности

3. **Обновляемость**
   - Возможность обновления логики проверки подписей
   - Механизм отзыва скомпрометированных подписей

## Связанные заметки
- [[Архитектурное решение]]
- [[EIP-2612]]
- [[Реализация EIP-2612]] 