Ниже представлено обсуждение архитектуры контракта, в котором любая NFT может быть раздроблена на конечное число взаимозаменяемых токенов с поддержкой offchain-подписей через permit. Дополнительные заметки можно найти в связанных заметках: [[Основы ERC-721]], [[Основы ERC-20]], [[EIP-2612]].

---

## 1. Основной принцип работы

- **Использование ERC-721 в качестве базового актива.**  
  - Каждая NFT выпускается по стандарту ERC-721.
  - Пока NFT целая, её владение определяется стандартными методами ERC-721.
  - [[Подробнее о стандарте ERC-721]]

- **Фракционирование NFT.**  
  - При вызове специальной функции NFT разбивается на конечное число фракционных токенов.
  - Исходная NFT переводится в залог (блокируется в контракте).
  - Владельцу выдаётся фиксированное количество фракционных токенов.
  - [[Примеры фракционирования NFT]]

- **Уникальность фракционных токенов для каждой NFT.**  
  - Для каждой NFT создаётся своя «виртуальная» система, напоминающая ERC-20.
  - Фракционные токены могут иметь индивидуальное имя и символ (например, `"Fractional NFT #<ID>"` и `"fNFT<ID>"`).

---

## 2. Структура данных и управление токенами

- **Хранение данных фракционных токенов.**  
  - Использование мэппинга для хранения информации о фракционных токенах для каждой NFT:
    ```solidity
    mapping(uint256 => FractionalToken) public fractionalTokens;
    ```
  - Структура `FractionalToken` может содержать:
    - `uint256 totalSupply;`
    - `mapping(address => uint256) balances;`
    - `mapping(address => mapping(address => uint256)) allowances;`
    - `mapping(address => uint256) nonces;` (для реализации permit по EIP-2612)
    - Параметры, такие как `name`, `symbol` и, возможно, `decimals`.
  - [[Структуры данных в Solidity]]

- **Интерфейс, похожий на ERC-20 для фракционных токенов.**  
  - Реализация методов `transfer`, `transferFrom`, `approve` и, особенно, `permit`.
  - Для идентификации используется дополнительный параметр, связывающий функцию с конкретной NFT.
  - [[ERC-20 vs. ERC-721]]

---

## 3. Процесс фракционирования и объединения

- **Функция разделения (split).**  
  - **Проверки:**
    - NFT должна быть целой.
    - Вызывающий должен быть владельцем NFT.
  - **Действия:**
    - NFT переводится в залог (контракт становится владельцем NFT).
    - Выпускается фиксированное количество фракционных токенов (параметризация возможна).
    - Эмитируется событие, фиксирующее разделение.
  - [[Процесс split NFT]]

- **Функция объединения (merge).**  
  - **Условие объединения:**  
    - Один адрес должен владеть более чем 95% фракционных токенов соответствующей NFT.
  - **Действия:**
    - Проверка распределения токенов.
    - Сжигание фракционных токенов.
    - Возврат исходной NFT владельцу.
  - **Вопрос:**  
    - Что делать, если менее 5% токенов распределены между несколькими адресами?  
    - Возможно, потребуется механизм «выкупа» оставшихся токенов или объединение будет недоступно.
  - [[Механизмы объединения NFT]]

---

## 4. Поддержка permit (EIP-2612) для фракционных токенов

- **Offchain подписи.**  
  - Каждая группа фракционных токенов поддерживает offchain-подписи для изменения разрешений без прямой транзакции.
  - Необходимо реализовать:
    - Хранилище `nonce` для каждого адреса в контексте конкретной NFT.
    - Уникальный доменный разделитель (domain separator), возможно, с учетом `tokenId`, чтобы подписи не пересекались.
  - [[Реализация EIP-2612]], [[Безопасность подписи]]

---

## 5. Методы для отображения информации

- **Целые NFT у пользователя.**  
  - Реализовать метод, который возвращает список NFT, находящихся в целостном состоянии (то есть не разделённых).
  - Возможно, потребуется хранение обратного мэппинга для оптимизации запросов.
  - [[Отображение целых NFT]]

- **Фракционные токены у пользователя.**  
  - Методы для:
    - Вывода списка NFT, для которых у пользователя есть фракционные токены.
    - Получения количества токенов для конкретной NFT.
    - Агрегации общего количества фракционных токенов у пользователя.
  - **Важно:**  
    - Эти методы лучше реализовать как `view`‑функции.
    - Для экономии газа и удобства можно использовать offchain‑индексирование (например, через The Graph).
  - [[Интерфейсы для отображения данных]]

---

## 6. Потенциальные сложности и спорные моменты

- **Хранение данных.**  
  - При большом количестве NFT мэппинги для каждого токена могут значительно увеличиться.
  - Рассмотреть возможность создания отдельных контрактов для фракционных токенов через фабрику.
  - [[Оптимизация хранения данных]]

- **Условие 95% для объединения.**  
  - В случае, если фракционные токены распределены между несколькими адресами, объединение может быть затруднено.
  - Возможно, стоит предусмотреть механизм «выкупа» оставшихся токенов.
  - [[Механизмы достижения 95% владения]]

- **Безопасность permit.**  
  - Строгое соблюдение стандартов EIP-712 и аккуратное обращение с nonce для каждого адреса.
  - Важно избегать уязвимостей, связанных с повторным использованием подписей.
  - [[Безопасность permit]]

- **Обратная совместимость.**  
  - Взаимодействие с существующими инструментами для ERC-721 и ERC-20.
  - Одна и та же NFT может существовать в двух состояниях: целая (ERC-721) и фракционированная (с ERC-20‑подобным интерфейсом).
  - [[Обратная совместимость стандартов]]

---

## 7. Архитектурные схемы

### Возможные диаграммы:
- **Основной поток:**  
  Целая NFT → разделение → хранение фракционных токенов → объединение → возврат целой NFT.
- **Взаимодействие:**  
  ERC-721 и «виртуальный» ERC-20‑интерфейс для фракционных токенов.
- **Потоки данных для permit:**  
  Подписи, nonce, доменный разделитель.
  
[[Схемы]]

---

## 8. Вопросы для обсуждения

1. **Количество фракционных токенов:**  
   - Будет ли фиксированное количество при разделении или параметризуемое?
   - Если фиксированное — какое значение оптимально для экономической модели?
   - [[Количество токенов при split NFT]]

2. **Механизм объединения:**  
   - Как поступать, если <5% токенов находятся у нескольких пользователей?
   - Необходим ли механизм «выкупа» оставшихся токенов или объединение возможно только при достижении порога 95%?
   - [[Механизмы объединения NFT]]

3. **Модульность реализации:**  
   - Стоит ли разделить контракт на два отдельных (один для ERC-721, второй для фракционных токенов)?
   - Это может облегчить поддержку permit, но усложнит развертывание и взаимодействие.
   - [[Модульность смарт-контрактов]]

4. **Оптимизация запросов:**  
   - Как обеспечить эффективный доступ к данным (например, список фракционных токенов для пользователя) без перебора огромных массивов on-chain?
   - Возможно, стоит использовать offchain‑индексирование.
   - [[Оптимизация запросов в блокчейне]]

---
[[Обсуждение архитектуры NFT]]