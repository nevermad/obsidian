В этом документе рассматриваются различные механизмы, позволяющие объединить фракционированные токены обратно в целую NFT. Данная функциональность крайне важна для поддержания гибкости владения активом, позволяя участникам вернуть исходное состояние NFT при соблюдении определённых условий.

[[Примеры фракционирования NFT]] · [[Основы ERC-721]] · [[Основы ERC-20]]

---

## 1. Обзор задачи

Фракционирование NFT позволяет разбивать уникальный актив на множество взаимозаменяемых токенов, которыми можно торговать как ERC-20. Однако, в определённых случаях может возникнуть потребность вернуть изначальную целостность NFT путем объединения фракций.

### Цели объединения:
- **Восстановление целостности:** Возможность вернуть NFT в её оригинальную форму.
- **Контроль над активом:** Гарантия, что объединение инициируется лицом, контролирующим значительную долю актива.
- **Экономическая эффективность:** Снижение риска злоупотреблений при дроблении и восстановлении NFT.

---

## 2. Основные механизмы объединения

### 2.1. Условие владения (Threshold Ownership)

Одним из ключевых требований является владение значительной долей фракционных токенов:
- **Порог владения:** Обычно требуется, чтобы инициатор объединения владел не менее чем 95% от общего количества фракций.
- **Пример проверки:** Если всего выпущено 1000 фракционных токенов, инициатор должен владеть минимум 950 токенами.
- **Цель:** Это условие гарантирует, что объединение происходит под контролем одного участника, а не в случае, когда актив распределён между множеством мелких инвесторов.

### 2.2. Процесс объединения

Процесс объединения может состоять из следующих этапов:

1. **Инициирование объединения:**
   - Пользователь вызывает функцию объединения (например, `mergeNFT`) в смарт-контракте, указывая идентификатор NFT.

2. **Проверка владения:**
   - Контракт проверяет баланс фракционных токенов инициатора по отношению к общему выпуску.
   - Если условие владения (например, 95%) выполнено, процесс продолжается.

3. **Сжигание фракционных токенов:**
   - Фракционные токены, находящиеся в распоряжении инициатора, сжигаются (burn), что уменьшает их общее количество.
   - Этот этап может включать полное сжигание всех токенов или только необходимой доли.

4. **Возврат NFT владельцу:**
   - После успешного сжигания токенов, исходная NFT переводится обратно инициатору.
   - Эмитируется событие (например, `NFTMerge`), фиксирующее успешное объединение.

#### Пример функции объединения на Solidity:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "./FractionalToken.sol";
import "./IERC721.sol";

contract FractionalNFT is IERC721 {
    // Маппинг, связывающий NFT с контрактом фракционных токенов
    mapping(uint256 => FractionalToken) public fractionalTokens;

    event NFTMerge(uint256 indexed tokenId, address indexed owner);

    // Функция для объединения фракционных токенов обратно в целую NFT
    function mergeNFT(uint256 tokenId) external {
        FractionalToken ft = fractionalTokens[tokenId];
        uint256 totalFractions = ft.totalSupply();
        uint256 userFractions = ft.balanceOf(msg.sender);
        // Проверка: владелец должен иметь минимум 95% от общего количества фракций
        require(userFractions * 100 / totalFractions >= 95, "Необходимо владение минимум 95% фракций");

        // Сжигание фракционных токенов
        ft.burn(userFractions);

        // Перевод NFT обратно владельцу
        _transfer(address(this), msg.sender, tokenId);

        // Эмитирование события объединения
        emit NFTMerge(tokenId, msg.sender);
    }
}
```

### 2.3. Управление оставшимися долями

В случае, когда объединение инициируется при владении менее чем 100% фракций, возникает вопрос, как обрабатывать оставшиеся доли:
- **Выкуп оставшихся долей:** Механизм, позволяющий инициатору объединения выкупить или получить компенсацию за оставшиеся фракционные токены.
- **Полное владение:** Требование полного (100%) владения фракциями до объединения, что упрощает логику, но снижает гибкость.
- **Частичное объединение:** Возможность объединить только ту часть, которая принадлежит инициатору, оставляя остаточные доли в обращении, хотя этот вариант может усложнить управление активом.

[[Примеры фракционирования NFT]] · [[Оптимизация запросов в блокчейне]]

## 3. Вызовы и риски

### 3.1. Распределение токенов между участниками
- **Проблема:** Если фракционные токены распределены между множеством участников, достижение порога владения может оказаться практически невозможным.
- **Решения:**
  - Внедрение механизма выкупа мелких долей
  - Использование голосования или консенсуса для объединения, где все держатели могут выразить своё согласие

### 3.2. Безопасность транзакций
- **Проверка подписей:** При использовании permit (EIP-2612) необходимо обеспечить корректную проверку подписей и nonce для предотвращения повторных атак.
- **Прозрачность:** Эмитирование событий на каждом этапе позволяет проводить аудит операций и повышает доверие к системе.

[[Безопасность permit]] · [[Основы ERC-721]]

### 3.3. Управление газовыми расходами
- **Оптимизация операций:** Объединение может требовать значительных вычислительных ресурсов, особенно при большом количестве фракционных токенов.
- **Рекомендации:** Использование offchain‑индексирования и оптимизация контрактов для снижения затрат газа.

[[Оптимизация запросов в блокчейне]]

## 4. Заключение

Механизмы объединения NFT являются важной составляющей системы фракционирования, позволяющей возвращать актив в его целостное состояние. Правильная реализация таких механизмов обеспечивает баланс между ликвидностью и контролем над активом.

Будущие разработки могут включать гибкие решения для выкупа оставшихся долей или интеграцию голосовых механизмов, что позволит учитывать различные сценарии распределения владения.

[[Обсуждение архитектуры NFT]] · [[Модульность смарт-контрактов]]