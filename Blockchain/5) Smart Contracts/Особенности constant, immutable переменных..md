## Короткий ответ

В Solidity `constant` и `immutable` переменные используются для определения неизменяемых значений. На уровне EVM они отличаются способом хранения и инициализации: значения `constant` встраиваются непосредственно в байт-код контракта во время компиляции, а значения `immutable` внедряются в байт-код во время развертывания. Оба типа переменных экономят газ, так как их значения не хранятся в `storage`.

---

## Подробный разбор

### **Constant**

#### **Определение:**
- Переменные, объявленные как `constant`, должны быть инициализированы во время компиляции.
- Значение `constant` переменной нельзя изменить после объявления.

#### **Пример:**
```solidity
uint constant MAX_SUPPLY = 1000;
```

#### **Технические детали на уровне EVM:**
- **Встраивание в байт-код:**
  - Значение `constant` переменной встраивается непосредственно в байт-код контракта.
  - При каждом обращении к переменной значение берется из байт-кода, а не из `storage`.
- **Опкоды:**
  - Используется опкод `PUSH`, чтобы загрузить значение `constant` переменной в стек.
- **Пример использования:**
  ```solidity
  function getSupplyLimit() public pure returns (uint) {
      return MAX_SUPPLY; // Значение берется из байт-кода
  }
  ```

#### **Особенности:**
- Использование `constant` переменных экономит газ, так как они не занимают место в `storage`.
- Поддерживаются только для value types (например, `uint`, `bool`, `address`).

#### **Подводные камни:**
- Значение должно быть известно во время компиляции, что ограничивает использование динамических данных.
- Нельзя использовать для данных, которые зависят от состояния контракта или внешних факторов.

---

### **Immutable**

#### **Определение:**
- Переменные, объявленные как `immutable`, могут быть инициализированы только один раз во время развертывания контракта.
- После инициализации значение `immutable` переменной нельзя изменить.

#### **Пример:**
```solidity
address immutable OWNER;
constructor() {
    OWNER = msg.sender; // Инициализация во время развертывания
}
```

#### **Технические детали на уровне EVM:**
- **Внедрение в байт-код:**
  - Значение `immutable` переменной также встраивается в байт-код контракта, но инициализируется во время выполнения конструктора.
  - Это позволяет использовать динамические данные (например, адрес развертывания).
- **Опкоды:**
  - Используется опкод `PUSH`, чтобы загрузить значение `immutable` переменной в стек.
- **Пример использования:**
  ```solidity
  function getOwner() public view returns (address) {
      return OWNER; // Значение берется из байт-кода
  }
  ```

#### **Особенности:**
- Использование `immutable` переменных экономит газ, так как они не занимают место в `storage`.
- Поддерживаются только для value types.

#### **Подводные камни:**
- Значение должно быть установлено в конструкторе, что требует осторожности при развертывании контракта.
- Нельзя изменить значение после развертывания, даже если это необходимо.

---

### **Сравнение `constant` и `immutable`**

| Характеристика      | `constant`                          | `immutable`                        |
|---------------------|-------------------------------------|------------------------------------|
| **Инициализация**   | Во время компиляции                | Во время развертывания            |
| **Значение**        | Должно быть известно заранее       | Может зависеть от динамических данных |
| **Хранение**        | В байт-коде                       | В байт-коде                      |
| **Газовые затраты** | Очень низкие                      | Низкие                           |
| **На уровне EVM**   | Значение встраивается через `PUSH` | Значение внедряется через `PUSH` |

---

### **Разница на уровне EVM**

#### **1) Constant:**
- **Встраивание:**
  - Значение `constant` переменной встраивается в байт-код контракта во время компиляции.
  - Пример:
    ```solidity
    uint constant MAX_SUPPLY = 1000;
    ```
    На уровне EVM:
    ```assembly
    PUSH 1000 // Значение MAX_SUPPLY
    ```

#### **2) Immutable:**
- **Внедрение:**
  - Значение `immutable` переменной внедряется в байт-код контракта во время развертывания.
  - Пример:
    ```solidity
    address immutable OWNER;
    constructor() {
        OWNER = msg.sender;
    }
    ```
    На уровне EVM:
    ```assembly
    PUSH <msg.sender> // Значение OWNER
    ```

---

### **Пример комбинированного использования**

```solidity
contract Example {
    uint constant MAX_SUPPLY = 1000;
    address immutable OWNER;
    constructor() {
        OWNER = msg.sender;
    }
    function getMaxSupply() public pure returns (uint) {
        return MAX_SUPPLY; // Значение берется из байт-кода
    }
    function getOwner() public view returns (address) {
        return OWNER; // Значение берется из байт-кода
    }
}
```

- **Анализ:**
  - `MAX_SUPPLY` — это `constant` переменная, значение которой известно во время компиляции.
  - `OWNER` — это `immutable` переменная, значение которой устанавливается во время развертывания.

---

### **Заключение**

`constant` и `immutable` переменные в Solidity обеспечивают эффективное использование памяти и экономию газа за счет внедрения значений в байт-код контракта. На уровне EVM они различаются способом инициализации: `constant` встраивается во время компиляции, а `immutable` — во время развертывания. Понимание этих механизмов критически важно для оптимизации смарт-контрактов.

---

## Связанные темы
- [Вернуться к списку вопросов](5.%20Список%20вопросов.md)
- [[Как работают модификаторы изменения состояния pure, view на уровне Solidity? Какие нюансы на уровне байткода EVM?]]
- [[Как расcчитывается номер слота для хранения переменных смарт-контракта?]]
- [[Что такое упаковка структур? Приведите примеры.]]

---

## Источники
- [Solidity Documentation - Constants and Immutables](https://docs.soliditylang.org/en/latest/contracts.html#constant-and-immutable-state-variables)
- [Understanding Constant and Immutable Variables in Solidity](https://ethereum.stackexchange.com/questions/96389/what-is-the-difference-between-constant-and-immutable-in-solidity)
- [The EVM Handbook](https://noxx3xxon.notion.site/noxx3xxon/The-EVM-Handbook-bb38e175cc404111a391907c4975426d)
- [EVM opcodes & instructions set](https://www.evm.codes/)
