## Короткий ответ
Переменные, объявленные в параметрах функций смарт-контракта, хранятся либо в `calldata`, либо в `memory`, в зависимости от типа данных и модификатора функции. На уровне EVM `calldata` представляет собой неизменяемую область памяти, которая передается в контракт через транзакцию или вызов, а `memory` используется для временного хранения изменяемых данных внутри функции.

---

## Подробный разбор

### **Где хранятся переменные?**

#### **1) calldata:**
- **Определение:**
  - `calldata` — это специальная область памяти, используемая для хранения аргументов, передаваемых в функцию.
  - Доступно только для чтения и не может быть изменено.
  - Применяется для внешних (`external`) функций.
- **Пример:**
  ```solidity
  function processArray(uint[] calldata data) external pure returns (uint) {
      return data.length; // Данные доступны только для чтения
  }
  ```

- **Технические детали на уровне EVM:**
  - `calldata` хранится вне контракта и доступно через опкоды:
    - `CALLDATALOAD`: Загружает данные из `calldata`.
    - `CALLDATASIZE`: Возвращает размер `calldata`.
    - `CALLDATACOPY`: Копирует данные из `calldata` в `memory`.

- **Особенности:**
  - Экономит газ, так как данные уже находятся в блокчейне.
  - Идеально подходит для больших массивов или сложных структур данных.

#### **2) memory:**
- **Определение:**
  - `memory` — это временная область памяти, используемая для хранения изменяемых данных внутри функции.
  - Может быть изменено во время выполнения функции.
  - Применяется для публичных (`public`) и внутренних (`internal`) функций.
- **Пример:**
  ```solidity
  function createArray(uint[] memory data) public pure returns (uint[] memory) {
      uint[] memory result = new uint[](data.length);
      for (uint i = 0; i < data.length; i++) {
          result[i] = data[i] * 2;
      }
      return result;
  }
  ```

- **Технические детали на уровне EVM:**
  - `memory` управляется через опкоды:
    - `MLOAD`: Загружает данные из `memory`.
    - `MSTORE`: Сохраняет данные в `memory`.
    - `MSTORE8`: Сохраняет один байт в `memory`.

- **Особенности:**
  - Требует выделения памяти, что увеличивает затраты газа.
  - Подходит для временных вычислений с изменяемыми данными.

---

### **Особенности хранения данных**

#### **1) calldata:**
- **Экономия газа:**
  - Чтение данных из `calldata` дешевле, чем использование `memory`, так как данные уже находятся в блокчейне.
- **Неизменяемость:**
  - Данные в `calldata` нельзя изменить, что делает их безопасными для использования в неизменяемых операциях.
- **Применение:**
  - Подходит для больших массивов или сложных структур данных, которые не требуют модификации.

#### **2) memory:**
- **Изменяемость:**
  - Данные в `memory` могут быть изменены, что делает их подходящими для временных вычислений.
- **Затраты газа:**
  - Выделение памяти требует больше газа, особенно для больших данных.
- **Применение:**
  - Подходит для временных вычислений, таких как обработка массивов или создание новых структур данных.

---

### **Пример комбинированного использования**

```solidity
function processData(uint[] calldata input) external pure returns (uint[] memory) {
    uint[] memory output = new uint[](input.length); // memory
    for (uint i = 0; i < input.length; i++) { // i хранится в stack
        output[i] = input[i] + 1;
    }
    return output;
}
```

- **Анализ:**
  - `input` хранится в `calldata`, так как это аргумент внешней функции.
  - `output` хранится в `memory`, так как это временный массив, созданный внутри функции.
  - Переменная `i` хранится в стеке EVM, так как это простой тип данных.

---

### **Заключение**

Переменные, объявленные в параметрах функций, хранятся либо в `calldata`, либо в `memory`, в зависимости от типа данных и модификатора функции. На уровне EVM `calldata` используется для неизменяемых данных, передаваемых через транзакции, а `memory` предоставляет временное хранилище для изменяемых данных. Понимание этих механизмов критически важно для оптимизации газовых затрат и эффективной разработки смарт-контрактов.

---

## Связанные темы
- [Вернуться к списку вопросов](5.%20Список%20вопросов.md)
- [[Какую функциональность добавляет ключевое слово calldata, memory? В чем отличие calldata и memory?]]
- [[Где хранятся переменные объявленные в теле функции смарт-контракта?]]
- [[Какие типы данных есть в Solidity?]]

---

## Источники
- [The EVM Handbook](https://noxx3xxon.notion.site/noxx3xxon/The-EVM-Handbook-bb38e175cc404111a391907c4975426d)
- [EVM opcodes & instructions set](https://www.evm.codes/)
- [Solidity Documentation - Data Location](https://docs.soliditylang.org/en/latest/types.html#data-location)
- [Understanding calldata and memory in Solidity](https://ethereum.stackexchange.com/questions/74442/when-should-i-use-calldata-and-when-should-i-use-memory)
