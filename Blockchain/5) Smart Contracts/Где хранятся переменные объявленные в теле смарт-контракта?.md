
## Короткий ответ

Переменные, объявленные в теле смарт-контракта, хранятся в `storage`. Это постоянное хранилище, которое сохраняется в блокчейне и существует на протяжении всего жизненного цикла контракта. На уровне EVM данные в `storage` организованы в слоты памяти размером 32 байта, каждый из которых адресуется по порядку объявления переменных. Операции с `storage` требуют значительных затрат газа.

---

## Подробный разбор

### **Что такое storage?**

#### **Определение:**
- **На уровне Solidity:**
  - `storage` — это постоянное хранилище, которое используется для хранения переменных состояния контракта.
  - Данные в `storage` сохраняются в блокчейне и остаются доступными даже после завершения выполнения функции.
  - Пример:
    ```solidity
    contract Example {
        uint public value; // Хранится в storage
    }
    ```

#### **На уровне EVM:**
- **Организация данных:**
  - Данные хранятся в слотах памяти (`storage slots`), каждый из которых имеет размер 32 байта.
  - Номер слота определяется порядком объявления переменных в контракте.
  - Пример:
    ```solidity
    contract StorageExample {
        uint public a; // Слот 0
        uint public b; // Слот 1
        uint[] public arr; // Слот 2 (указатель на массив)
    }
    ```

- **Опкоды:**
  - `SLOAD`: Загружает данные из `storage`.
  - `SSTORE`: Сохраняет данные в `storage`.

#### **Технические детали:**
- **Газовые затраты:**
  - Чтение данных из `storage` (`SLOAD`) стоит значительно больше газа, чем чтение из `memory` или `calldata`.
  - Запись данных в `storage` (`SSTORE`) еще дороже, особенно если изменяется значение в слоте.

---

### **Особенности storage**

#### **1) Постоянство данных:**
- Переменные в `storage` сохраняются между вызовами функций.
- Например, если вы измените значение переменной в одной транзакции, оно останется таким же в следующей.

#### **2) Инициализация:**
- Переменные в `storage` автоматически инициализируются дефолтными значениями:
  - `0` для чисел.
  - `false` для булевых значений.
  - Пустой массив для динамических массивов.

#### **3) Упаковка данных:**
- Если несколько переменных могут быть упакованы в один слот (например, несколько `uint8`), они занимают один слот для экономии места.
- Пример:
  ```solidity
  contract PackedStorage {
      uint128 public a; // Часть слота 0
      uint128 public b; // Часть слота 0
  }
  ```

---

### **Как данные организованы в storage?**

#### **1) Простые типы данных:**
- Простые типы данных (например, `uint`, `bool`, `address`) занимают один или несколько слотов в зависимости от их размера.
- Пример:
  ```solidity
  contract SimpleStorage {
      uint public a; // Слот 0
      bool public b; // Слот 1
  }
  ```

#### **2) Сложные типы данных:**
- **Массивы:**
  - Фиксированные массивы хранятся последовательно в слотах.
  - Динамические массивы хранят указатель на начало данных в слоте, а сами данные хранятся в отдельных слотах.
  - Пример:
    ```solidity
    contract ArrayStorage {
        uint[] public arr; // Слот 0 (указатель)
    }
    ```

- **Маппинги:**
  - Маппинги хранят ключи и значения в отдельных слотах, вычисляемых через хэширование.
  - Пример:
    ```solidity
    contract MappingStorage {
        mapping(uint => uint) public map; // Слот 0 (начало маппинга)
    }
    ```

---

### **Ограничения**

#### **1) Высокие затраты газа:**
- Операции с `storage` дороже, чем с `memory` или `calldata`.
- Пример:
  ```solidity
  function updateValue(uint newValue) public {
      value = newValue; // SSTORE операция
  }
  ```

#### **2) Неэффективность для больших данных:**
- Частое изменение больших объемов данных в `storage` может быть крайне затратным.
- Рекомендуется минимизировать использование `storage` для временных вычислений.

---

### **Заключение**

`storage` — это ключевая часть смарт-контрактов, обеспечивающая постоянное хранение данных в блокчейне. На уровне EVM данные организованы в слоты памяти размером 32 байта, и операции с `storage` требуют значительных затрат газа. Понимание организации данных в `storage` критически важно для эффективной разработки смарт-контрактов.

---

## Связанные темы
- [Вернуться к списку вопросов](5.%20Список%20вопросов.md)
- [[Где хранятся переменные объявленные в теле функции смарт-контракта?]]
- [[Как расcчитывается номер слота для хранения переменных смарт-контракта?]]
- [[Какие типы данных есть в Solidity?]]

---

## Источники
- [The EVM Handbook](https://noxx3xxon.notion.site/noxx3xxon/The-EVM-Handbook-bb38e175cc404111a391907c4975426d)
- [EVM opcodes & instructions set](https://www.evm.codes/)
- [Solidity Documentation - Storage](https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#storage-memory-and-the-stack)
- [Understanding Ethereum Storage Layout](https://medium.com/@hayeah/diving-into-the-ethereum-vm-part-2-storage-layout-bc5349cb11b7)
- [Официальная документация по layout storage](https://docs.soliditylang.org/en/stable/internals/layout_in_storage.html)
