
## Короткий ответ

Если `view` функция попытается изменить состояние контракта, транзакция будет отменена сразу при компиляции или выполнении. Это происходит потому, что `view` функции не имеют права изменять состояние, и любая попытка записи в `storage` вызывает ошибку.

---

## Подробный разбор

### **Что происходит при попытке изменения состояния в `view` функции?**
1. **Определение проблемы:**
   - Функции с модификатором `view` могут только читать состояние контракта.
   - Любая попытка изменения состояния (например, запись в переменную `storage`) нарушает это правило.

2. **Пример ошибки:**
   ```solidity
   uint public value;

   function updateValue(uint _value) public view {
       value = _value; // Ошибка: Cannot modify state in a view function
   }
   ```

3. **Технические детали:**
   - На уровне байт-кода EVM `view` функции не содержат операций записи в `storage`.
   - Попытка выполнить такую операцию вызывает исключение (`revert`) на этапе выполнения.

4. **Последовательность событий:**
   - Если ошибка обнаруживается во время компиляции:
     - Компилятор Solidity выдает ошибку: `TypeError: Function declared as view, but this expression modifies the state`.
   - Если ошибка возникает во время выполнения (например, при взаимодействии с другим контрактом):
     - Транзакция отменяется сразу после попытки изменения состояния.

5. **Подводные камни:**
   - Некорректное использование модификатора `view` может привести к неправильной логике контракта.
   - Взаимодействие с другими контрактами через `view` функции требует осторожности, чтобы избежать побочных эффектов.

---

### **Пример использования**
```solidity
contract Example {
    uint public value;

    function getValue() public view returns (uint) {
        return value; // Чтение состояния разрешено
    }

    function setValue(uint _value) public {
        value = _value; // Изменение состояния разрешено
    }

    function invalidUpdate(uint _value) public view {
        value = _value; // Ошибка: Cannot modify state in a view function
    }
}
```

- В этом примере:
  - `getValue` — это корректная `view` функция, которая читает значение переменной `value`.
  - `setValue` изменяет состояние контракта.
  - `invalidUpdate` вызовет ошибку, так как пытается изменить состояние внутри `view` функции.

---

### **Как избежать ошибок?**
1. **Проверка кода:**
   - Убедитесь, что `view` функции не содержат операций записи в `storage`.
   - Используйте статический анализатор кода для обнаружения потенциальных проблем.

2. **Тестирование:**
   - Протестируйте все `view` функции, чтобы убедиться, что они не изменяют состояние.
   - Используйте инструменты, такие как Hardhat или Truffle, для автоматизации тестирования.

3. **Документация:**
   - Четко документируйте назначение каждой функции, чтобы избежать недоразумений.

---

### **Нюансы на уровне байт-кода EVM**
1. **View Functions:**
   - На уровне байт-кода `view` функции могут содержать операции чтения из `storage`.
   - Не содержат операций записи в `storage`.

2. **Gas Costs:**
   - Вызов `view` функции не требует газа, если она выполняется вне транзакции (например, через `call`).
   - Если функция вызывается внутри транзакции, она потребляет газ за выполнение операций.

3. **Revert:**
   - При попытке изменения состояния в `view` функции вызывается исключение (`revert`), которое отменяет транзакцию.

---

### **Пример комбинированного использования**
```solidity
contract Bank {
    uint public balance;

    function deposit(uint amount) public {
        balance += amount;
    }

    function getBalance() public view returns (uint) {
        return balance; // Чтение состояния разрешено
    }

    function invalidWithdraw(uint amount) public view {
        balance -= amount; // Ошибка: Cannot modify state in a view function
    }
}
```

- В этом примере:
  - `getBalance` — это корректная `view` функция, которая читает значение переменной `balance`.
  - `invalidWithdraw` вызовет ошибку, так как пытается изменить состояние внутри `view` функции.

---

## Связанные темы
- [Вернуться к списку вопросов](5.%20Список%20вопросов.md)
- [[Как работают модификаторы изменения состояния pure, view на уровне Solidity? Какие нюансы на уровне байткода EVM?]]
- [[Что такое упаковка структур? Приведите примеры.]]

---

## Источники
- [Solidity Documentation - Pure and View Functions](https://docs.soliditylang.org/en/latest/contracts.html#pure-functions)
- [Understanding Pure and View Functions in Solidity](https://ethereum.stackexchange.com/questions/91874/what-is-the-difference-between-pure-and-view-functions-in-solidity)
---