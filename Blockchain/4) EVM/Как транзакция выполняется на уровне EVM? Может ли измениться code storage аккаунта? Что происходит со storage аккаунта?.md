---
title: Как транзакция выполняется на уровне EVM?
tags: [EVM, Ethereum, Транзакции, Выполнение транзакции, State Trie, Gas, Opcodes]
---

## Короткий ответ

EVM выполняет транзакции последовательно, используя **стек**, **память** и **хранилище**. Code storage аккаунта **неизменен**, но storage аккаунта **может изменяться**.


## Подробный разбор

**1. Получение транзакции:**

* Майнер получает транзакцию из **mempool**.
* Проверяется **валидность** транзакции: подпись, nonce, достаточный баланс для оплаты gas fee.


**2. Выполнение транзакции:**

* **Создание execution environment (среды выполнения):** Для каждой транзакции создается isolated environment (изолированная среда) с собственным  **стеком**,  **памятью** и доступом к **глобальному состоянию** блокчейна.
* **Gas Metering:**  EVM отслеживает потребление gas during execution (во время выполнения).  Если gas исчерпан, транзакция отменяется (reverted). (см. [[В чем различие Gas Price и Gas Limit?]])
* **Выполнение опкодов:** Транзакция, содержащая **bytecode**, декодируется в sequence of opcodes (последовательность опкодов) - elementary instructions (элементарные инструкции) для EVM.  EVM выполняет эти опкоды последовательно, изменяя состояние execution environment (среды выполнения).
* **Изменение State Trie:** Если транзакция изменяет состояние блокчейна (например,  перевод Ether, изменение данных в storage контракта),  эти изменения записываются в  **State Trie**  -  Merkle Patricia Trie,  representing the global state (представляющее глобальное состояние).  (см. [[Расскажите об основных компонентах EVM? Какие сущности существуют постоянно, какие временно? Расскажите о их жизненном цикле.]])


**3. Code Storage и Storage аккаунта:**

* **Code Storage:** Code storage аккаунта, содержащий bytecode смарт-контракта,  **неизменен**.  Транзакция не может изменить код уже развернутого контракта. (см. [[Можно ли изменить код контракта?]])
* **Storage:**  Storage аккаунта,  persistent storage area for smart contracts (постоянная область хранения для смарт-контрактов),   **может изменяться** в результате выполнения транзакции.   Запись данных в storage потребляет gas. (см. [[Расскажите о свойствах, особенностях, ограничениях, времени жизни информации, каким образом структурирован storage.]])


**4. Результат транзакции:**

* **Успешное выполнение:**  Если транзакция выполнена успешно,  изменения state  записываются в блок,  и gas fee перечисляется майнеру.
* **Ошибка (Revert):** Если во время выполнения произошла ошибка (например, не хватило gas,  ошибка в коде контракта),  транзакция отменяется,  изменения state откатываются,  но gas fee все равно списывается.




## Связанные темы

* [Вернуться к списку вопросов](4.%20Список%20вопросов.md)
* [[Что такое газ?]]
* [[В чем различие Gas Price и Gas Limit?]]
* [[Расскажите об основных компонентах EVM? Какие сущности существуют постоянно, какие временно? Расскажите о их жизненном цикле.]]
* [[Расскажите о свойствах, особенностях, ограничениях, времени жизни информации, каким образом структурирован storage.]]


## Источники

* [Ethereum Documentation - EVM](https://ethereum.org/en/developers/docs/evm/)
* [Yellow Paper - EVM](https://ethereum.github.io/yellowpaper/paper.pdf#page=12)


---