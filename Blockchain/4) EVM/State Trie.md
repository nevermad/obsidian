## Короткий ответ

**State Trie** - это структура данных типа Merkle Patricia Trie, которая используется в Ethereum для эффективного хранения и проверки состояния всего блокчейна, включая балансы счетов, nonce и код смарт-контрактов.


## Подробный разбор

**Что такое Trie?**

Trie (произносится как "try") - это древовидная структура данных, используемая для хранения данных в виде key-value пар.  **Patricia Trie** - это оптимизированный вариант Trie, который эффективно сжимает общие префиксы ключей, уменьшая размер хранилища.  **Merkle Patricia Trie** добавляет к Patricia Trie  криптографические хэши, позволяя эффективно верифицировать целостность данных.  

**State Trie в Ethereum:**

В Ethereum State Trie используется для представления **глобального состояния** блокчейна. Каждый **узел** в State Trie представляет собой key-value пару, где:

* **Key:**  Это  hashed representation (хэш-представление) адреса аккаунта (160 бит).  
* **Value:**  Это  RLP-encoded representation (RLP-кодированное представление) состояния аккаунта,  которое включает:
    * **nonce:**  Счетчик транзакций.
    * **balance:**  Баланс аккаунта в Wei.
    * **storageRoot:**  Корень Merkle Patricia Trie,  представляющего storage (хранилище) аккаунта.  (Storage Trie - см. ниже)
    * **codeHash:**  Хэш bytecode  смарт-контракта (если аккаунт является контрактом).


**Storage Trie:**

Каждый аккаунт контракта имеет свой собственный **Storage Trie**,  который также является Merkle Patricia Trie.  Storage Trie  хранит данные,  связанные с контрактом,  в виде key-value пар,  где:

* **Key:** 256-битный хэш ключа storage.
* **Value:** 256-битное значение,  соответствующее ключу.

**Зачем использовать State Trie?**

* **Эффективное хранение:** State Trie  сжимает данные,  уменьшая размер хранилища,  необходимого для хранения состояния всего блокчейна.
* **Быстрая верификация:** Merkle Patricia Trie  позволяет эффективно верифицировать целостность данных.  Для проверки  данных аккаунта  необходимо  знать только  Merkle Proof -  путь от  корня Trie до  листа,  содержащего данные аккаунта.
* **Simplified Synchronization (Упрощенная синхронизация):**  Новые узлы  могут быстро синхронизироваться с  блокчейном,  загружая только  необходимые части  State Trie.

**Изменения State Trie:**

После каждой транзакции State Trie  **изменяется**.  Изменения записываются в  новый блок,  и  корень нового State Trie  включается в  header блока.   Эта цепочка  корней State Trie  формирует  историю изменений состояния  блокчейна.


## Связанные темы

* [Вернуться к списку вопросов](4.%20Список%20вопросов.md)
* [[Как транзакция выполняется на уровне EVM? Может ли измениться code storage аккаунта? Что происходит со storage аккаунта?]]

## Источники

* [Ethereum Documentation - State Trie](https://ethereum.org/en/developers/docs/data-structures-and-encoding/patricia-merkle-trie/)
* [Yellow Paper - State Trie](https://ethereum.github.io/yellowpaper/paper.pdf#page=23)


