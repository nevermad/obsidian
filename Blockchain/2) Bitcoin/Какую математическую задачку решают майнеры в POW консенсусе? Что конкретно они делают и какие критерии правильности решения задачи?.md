
**Короткий ответ**: В Proof of Work майнеры решают задачу нахождения значения **nonce**, при котором хэш заголовка блока оказывается меньше заданного **target**. Они используют метод перебора (brute force), чтобы найти корректный хэш, удовлетворяющий текущей сложности сети.

---

## Подробный разбор

### Математическая задача в PoW

1. **Формулировка задачи**:
   - Необходимо найти значение **nonce**, такое что:
     $$
     Hash(BlockHeader) \leq Target
     $$
   - **BlockHeader** — это данные заголовка блока, включающие:
     - Хэш предыдущего блока.
     - Merkle Root (см. [[Используется ли MerkleTree в блоке? Если да, то для чего?]]).
     - Временную метку.
     - Текущее значение nonce.
     - **ExtraNonce** (см. ниже).

2. **Вычисление хэша**:
   - Хэш блока вычисляется с использованием алгоритма SHA-256 дважды (Double SHA-256).
   - Майнеры изменяют nonce и **extraNonce** для генерации новых хэшей до тех пор, пока не найдут подходящее значение.

3. **Target и сложность (Difficulty)**:
   - **Target** — числовое значение, задающее верхнюю границу для хэша.
   - Чем ниже target, тем сложнее найти подходящий хэш, поскольку уменьшается вероятность успешного совпадения.
   - Подробнее см. [[Difficulty & Target в чем отличие?]].

---

### Что такое extraNonce?

1. **Назначение**:
   - **Nonce** в заголовке блока ограничен 4 байтами (значения от 0 до \(4,294,967,295\)).
   - Если все значения nonce исчерпаны, майнеры изменяют **extraNonce**, который включён в coinbase-транзакцию.

2. **Механизм работы**:
   - Изменение extraNonce приводит к изменению Merkle Root, который входит в заголовок блока.
   - Это позволяет продолжить поиск валидного хэша.

---

### Что конкретно делают майнеры?

1. **Получение блока для майнинга**:
   - Майнер получает блок, сформированный из транзакций в [[mempool]].
   - Он добавляет coinbase-транзакцию, чтобы получить награду за блок.

2. **Изменение nonce и extraNonce**:
   - Майнер сначала перебирает все значения nonce.
   - Если nonce исчерпаны, изменяется extraNonce в coinbase-транзакции, что приводит к изменению Merkle Root.

3. **Вычисление хэша**:
   - Каждое изменение nonce или extraNonce приводит к новому хэшу.
   - Если хэш меньше target, блок считается успешным.

4. **Отправка найденного блока**:
   - Когда подходящий nonce найден, майнер транслирует блок в сеть для проверки другими узлами.

---

### Валидность блока

1. **Хэш меньше target**:
   - Узлы сети проверяют, что:
     $$
     Hash(BlockHeader) \leq Target
     $$

2. **Валидность транзакций**:
   - Все транзакции в блоке должны быть валидными:
     - Подписи транзакций корректны.
     - Входы транзакций не потрачены ранее.
     - Сумма входов равна или превышает сумму выходов.

3. **Правильность цепочки**:
   - Хэш блока должен ссылаться на хэш предыдущего блока.
   - Это обеспечивает связь между блоками и предотвращает форки.

---

### Как решается проблема форков?

1. **Причина форков**:
   - Форк возникает, если два или более майнера одновременно находят валидный блок.

2. **Решение**:
   - Узлы сети принимают цепочку с наибольшей совокупной сложностью (или длиной).
   - Блоки из "побеждённой" цепочки становятся "сиротами" (orphaned blocks) и не принимаются сетью.

3. **Локальная обработка блока**:
   - Узлы добавляют новый блок в свою локальную копию цепочки только после проверки его валидности.
   - Если позже поступает блок с большей сложностью, узлы переключаются на новую цепочку.

---

### Связанные темы
- [[Nonce 4 байт, значения могут быть от 0 to 4,294,967,295. Что делать если перебрали все nonce, но не решили математическую задачку?]]
- [[За счет чего достигается неизменность данных в блокчейне?]]
- [[Что такое пулы майнинга? Как они работают?]]
- [[Как связаны блоки в цепочке?]]

---

### Источники
1. [Bitcoin Whitepaper](https://bitcoin.org/bitcoin.pdf)
2. [Proof of Work Explained](https://en.bitcoin.it/wiki/Proof_of_work)
3. [ExtraNonce in Mining](https://en.bitcoin.it/wiki/Nonce#ExtraNonce)