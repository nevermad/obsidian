
**Короткий ответ**: P2SH (Pay-to-Script-Hash) позволяет отправлять средства на хэш произвольного скрипта. Средства могут быть потрачены, только если предоставлен скрипт, соответствующий этому хэшу, и данные, которые делают его выполнение успешным. Это упрощает работу с более сложными сценариями, такими как мультиподписи.

---

## Подробный разбор

### Что такое P2SH?

P2SH — это механизм, при котором вместо отправки средств на хэш публичного ключа (как в P2PKH) средства отправляются на хэш скрипта. Получатель должен предоставить:
1. Сам скрипт.
2. Данные для успешного выполнения скрипта.

---

### Как работает P2SH?

1. **Создание транзакции**:
   - Отправитель формирует выход (output), указывая:
     - **Value**: Сумма BTC.
     - **ScriptPubKey**: Скрипт, блокирующий средства.
   - Пример ScriptPubKey:
     ```
     OP_HASH160 <Redeem Script Hash> OP_EQUAL
     ```
   - `Redeem Script Hash` — хэш Redeem Script (вторичного скрипта).

2. **Расходование средств**:
   - Чтобы потратить средства, владелец предоставляет:
     - Полный Redeem Script.
     - Данные, необходимые для выполнения Redeem Script.
   - ScriptSig:
     ```
     <Data> <Redeem Script>
     ```

3. **Проверка**:
   - Узлы проверяют:
     1. Redeem Script хэшируется, и результат сравнивается с `Redeem Script Hash` в ScriptPubKey.
     2. Если хэши совпадают, выполняется Redeem Script с предоставленными данными.

---

### Пример использования P2SH

#### Мультиподпись

1. **Создание Redeem Script**:
   - Требуется 2 из 3 подписей:
     ```
     OP_2 <Public Key 1> <Public Key 2> <Public Key 3> OP_3 OP_CHECKMULTISIG
     ```

2. **Создание P2SH адреса**:
   - Хэш Redeem Script:
     ```
     Hash160(Redeem Script)
     ```

3. **Отправка средств**:
   - ScriptPubKey:
     ```
     OP_HASH160 <Redeem Script Hash> OP_EQUAL
     ```

4. **Расходование средств**:
   - ScriptSig:
     ```
     <Signature 1> <Signature 2> <Redeem Script>
     ```
   - Узлы:
     1. Проверяют хэш Redeem Script.
     2. Выполняют Redeem Script с подписями.

---

### Преимущества P2SH

1. **Гибкость**:
   - Поддерживает сложные сценарии (мультиподписи, блокировка по времени).

2. **Компактность**:
   - Отправителю нужно знать только хэш Redeem Script, а не полный скрипт.

3. **Безопасность**:
   - Реализация дополнительных правил расходования средств, таких как требование нескольких подписей.

---

### Примеры использования

1. **Мультиподпись**:
   - Средства можно потратить только при наличии нескольких подписей.

2. **Time-Locked транзакции**:
   - Средства блокируются до определённого времени.

3. **Atomic Swaps**:
   - Обеспечение выполнения обмена между двумя пользователями.

---

### Связанные темы
- [[P2PKH как работает алгоритм?]]
- [[Структура транзакций, какие поля имеются и для чего нужны?]]
- [[Как Public Key и Private Key связан с UTXO?]]

---

### Источники
1. [Bitcoin Developer Guide: P2SH](https://bitcoin.org/en/developer-guide#pay-to-script-hash)
2. [Bitcoin Wiki: Pay-to-Script-Hash](https://en.bitcoin.it/wiki/Pay_to_script_hash)
3. [P2SH and Multisignature Explained](https://medium.com/coinmonks/p2sh-and-multisig-scripts-explained-3e96db38f48a)