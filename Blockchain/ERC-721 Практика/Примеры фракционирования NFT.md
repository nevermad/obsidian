В этом документе рассматривается процесс фракционирования NFT — механизм разделения одной целой NFT на множество взаимозаменяемых токенов, а также обратный процесс объединения. Такие подходы открывают новые возможности для инвестиций, повышения ликвидности и управления уникальными активами.
[[Основы ERC-721]] · [[Основы ERC-20]] · [[EIP-2612]]

---

## 1. Введение

NFT (невзаимозаменяемые токены) традиционно представляют собой уникальные активы, которыми можно владеть целиком. Фракционирование NFT позволяет разделить владение одним активом между несколькими участниками, при этом каждый участник получает долю в виде взаимозаменяемого токена. Это может значительно снизить порог входа для инвесторов, повысить ликвидность и дать возможность дробного владения дорогостоящими активами.

---
## 2. Механика фракционирования

### 2.1 Процесс разделения (Split)
Процесс разделения NFT на фракционные токены включает несколько ключевых шагов:

1. **Проверка прав владения:**
   - Перед началом операции необходимо убедиться, что инициатор фракционирования действительно является владельцем NFT. Это реализуется стандартными методами ERC-721 (например, `ownerOf`).

2. **Перевод NFT в залог:**
   - Для обеспечения безопасности и неизменности актива NFT переводится на адрес контракта, где она находится в состоянии залога. Это гарантирует, что никто не сможет манипулировать NFT во время её дробления.

3. **Выпуск фракционных токенов:**
   - После блокировки NFT создаётся фиксированное количество фракционных токенов, которые отражают доли владения исходной NFT.
   - Каждый NFT может иметь собственный контракт или внутреннюю структуру для управления фракционными токенами. Обычно реализуется система, напоминающая ERC-20, с поддержкой функций `transfer`, `approve` и даже `permit` (EIP-2612) для offchain-подписей.
   - Фракционные токены могут быть настроены с уникальными именем и символом, зависящими от идентификатора исходной NFT.

4. **Эмитирование событий:**
   - По завершении операции контракт эмитирует событие (например, `NFTSplit`), которое фиксирует факт разделения и позволяет внешним системам отслеживать изменения.

Пример функции split на Solidity:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "./IERC721.sol";
import "./FractionalToken.sol";

contract FractionalNFT is IERC721 {
    // Маппинг для связи NFT с её фракционными токенами
    mapping(uint256 => FractionalToken) public fractionalTokens;

    event NFTSplit(uint256 indexed tokenId, uint256 fractions);

    // Функция для фракционирования NFT
    function splitNFT(uint256 tokenId, uint256 fractions) external {
        // Проверка владения NFT
        require(ownerOf(tokenId) == msg.sender, "Вы не являетесь владельцем NFT");
        require(fractions > 1, "Количество фракций должно быть больше 1");

        // Перевод NFT в залог: контракт становится владельцем NFT
        _transfer(msg.sender, address(this), tokenId);

        // Создание контракта фракционных токенов для данной NFT
        FractionalToken ft = new FractionalToken(fractions, tokenId);
        fractionalTokens[tokenId] = ft;

        // Эмитирование события
        emit NFTSplit(tokenId, fractions);
    }
}
```

### 2.2 Процесс объединения (Merge)

Объединение фракционных токенов обратно в целую NFT осуществляется при условии, что один из участников владеет значительной долей (например, более 95%) от общего количества фракционных токенов.

1. **Проверка владения фракционными токенами:**
   - Перед объединением необходимо убедиться, что инициатор владеет не менее 95% от общего количества выпущенных фракций. Это гарантирует, что объединение инициируется лицом, имеющим контроль над активом.

2. **Сжигание фракционных токенов:**
   - После проверки условие объединения выполняется, и соответствующее количество фракционных токенов сжигается. Это уменьшает общее количество выпущенных фракций до нуля или до оставшихся долей, которые не входят в объединение.

3. **Возврат NFT владельцу:**
   - После успешного объединения NFT переводится обратно владельцу, который инициировал операцию.

Пример функции merge на Solidity:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "./FractionalToken.sol";
import "./IERC721.sol";

contract FractionalNFT is IERC721 {
    mapping(uint256 => FractionalToken) public fractionalTokens;

    event NFTMerge(uint256 indexed tokenId, address indexed owner);

    // Функция для объединения фракционных токенов обратно в NFT
    function mergeNFT(uint256 tokenId) external {
        FractionalToken ft = fractionalTokens[tokenId];
        uint256 totalFractions = ft.totalSupply();
        uint256 userFractions = ft.balanceOf(msg.sender);
        // Проверка: владелец должен иметь минимум 95% от общего количества фракций
        require(userFractions * 100 / totalFractions >= 95, "Необходимо владение минимум 95% фракций");

        // Сжигание фракционных токенов
        ft.burn(userFractions);

        // Перевод NFT обратно владельцу
        _transfer(address(this), msg.sender, tokenId);

        // Эмитирование события объединения
        emit NFTMerge(tokenId, msg.sender);
    }
}
```

### 3. Примеры использования

1. **Инвестиционные платформы:**
   - **Дробное владение:** Инвесторы могут покупать доли дорогих NFT, что снижает финансовые барьеры для входа на рынок.
   - **Платформы совместного владения:** Позволяют нескольким участникам владеть частью уникального актива, распределяя риски и прибыль.

2. **Повышение ликвидности NFT:**
   - **Торговля долями NFT:** Фракционные токены, обладая свойствами ERC-20, могут свободно торговаться на децентрализованных биржах, обеспечивая ликвидность активов, которые в противном случае сложно продать целиком.
   - **Ликвидные пулы:** Создание пулов ликвидности для обмена фракциями NFT, что позволяет инвесторам покупать и продавать доли без ожидания объединения.

3. **Краудфандинговые проекты:**
   - **Финансирование проектов:** Фракционирование может использоваться для привлечения инвестиций, когда проект выпускает фракционные токены вместо традиционных акций или облигаций.
   - **Распределение прав:** Участники получают долю в активе, что может быть использовано для голосования или участия в распределении прибыли.

### 4. Технические аспекты и вызовы

1. **Безопасность и проверка владения:**
   - **Проверка владельца:** Ключевым аспектом является проверка, что инициатор фракционирования или объединения действительно владеет NFT или достаточным количеством фракционных токенов.
   - **Защита от атак:** Использование nonce и EIP-2612 (permit) позволяет защититься от повторного использования подписей и атак типа replay.

[[Безопасность permit]]

2. **Управление данными:**
   - **Структура хранения:** Для отслеживания фракционных токенов используется мэппинг, связывающий идентификатор NFT с соответствующим контрактом фракционных токенов.
   - **Оптимизация запросов:** При большом количестве NFT запросы о балансе фракций могут стать дорогостоящими on-chain, что требует применения offchain-индексации (например, с помощью The Graph).

[[Оптимизация запросов в блокчейне]]

3. **Пользовательский интерфейс:**
   - **Отображение информации:** Необходимо создать удобные методы и API для получения данных о целых NFT, распределении фракций и статистике владения.
   - **Интеграция с кошельками:** Функциональность должна поддерживаться популярными кошельками для отображения фракционных токенов наряду с традиционными NFT.

[[Отображение целых NFT]] · [[Интерфейсы для отображения данных]]

### 5. Заключение

Фракционирование NFT — это инновационный подход к владению и управлению уникальными активами. Он открывает двери для:
- Дробного инвестирования
- Повышения ликвидности
- Создания новых финансовых инструментов на основе NFT

Реализация данного механизма требует внимательного подхода к вопросам безопасности, оптимизации хранения данных и удобства для конечного пользователя. Продуманная архитектура, основанная на стандартах ERC-721, ERC-20 и EIP-2612, позволит создать надежное и гибкое решение для фракционирования NFT.

[[Обсуждение архитектуры NFT]] · [[Модульность смарт-контрактов]]